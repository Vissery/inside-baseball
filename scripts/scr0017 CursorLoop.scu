; SCRP 17 CursorLoop

local variable x
local variable y
local variable id
local variable type
local variable cursor_image
local variable local5
local variable flags
local variable last_flags
local variable local8
local variable local9
local variable local10

do {
    if (gCursorVisible > 0 || gGamePadCursorSprite) {
        if (gUIInputDevice == INPUT-DEVICE-GAME-PAD) {
            x = gGamePadX
            y = gGamePadY
        } else {
            x = gMouseX
            y = gMouseY
        }
        id = 0
        type = 0
        flags = 0
        if (!gAlternateInput_always_false) {
            id = sprite-get-x2d x y 0 0 [18, 32]
            if (id) {
                if (gSpriteCursorTargets[id][TARGET-CLICK-SCRIPT] || gSpriteCursorTargets[id][TARGET-HOVER-SCRIPT]) {
                    flags = sprite-has-class id []
                    type = 2
                    flags = flags | 132
                } else {
                    id = 0
                }
            }
            if (!type) {
                id = x9f x y
                if (id) {
                    if (gActorCursorTargets[id][TARGET-CLICK-SCRIPT] || gActorCursorTargets[id][TARGET-HOVER-SCRIPT]) {
                        flags = get-class id []
                        type = 1
                        flags = flags | 132
                    } else {
                        id = 0
                        flags = 0
                    }
                }
            }
            if (!type) {
                id = xa0 x y
                if (id) {
                    if ((xa3 id 1) || (xa3 id 3)) {
                        type = 3
                        flags = get-class id []
                        flags = flags | 132
                    } else {
                        id = 0
                        flags = 0
                    }
                }
            }
            if (gMouseHookScript) {
                local10 = call-script gMouseHookScript [type, id]
                if (local10) {
                    id = local10
                    type = 6
                    flags = gMouseHookFlags
                }
            }
            if (type != gLastHoverType || id != gLastHoverNumber) {
                if (type && id && gHoverScript) {
                    run-script gHoverScript [id, type]
                }
                case type {
                    of 2 {
                        local8 = gSpriteCursorTargets[id][TARGET-HOVER-DELAY]
                    }
                    of 1 {
                        local8 = gActorCursorTargets[id][TARGET-HOVER-DELAY]
                    }
                    of 3 {
                        local8 = 0
                    }
                    else {
                        local8 = 0
                    }
                }
                if (id != 0 && flags != last_flags) {
                    cursor_image = 0
                    if (flags & 131072) {
                        cursor_image = 1
                    } else {
                        if (flags & 524288) {
                            local5 = 31 - 7
                        } else if (flags & 1048576) {
                            local5 = 55 - 7
                        } else {
                            local5 = 0
                        }
                        case 1 {
                            of flags & 256 > 0 {
                                cursor_image = 7 + local5
                            }
                            of flags & 512 > 0 {
                                cursor_image = 10 + local5
                            }
                            of flags & 1024 > 0 {
                                cursor_image = 13 + local5
                            }
                            of flags & 2048 > 0 {
                                cursor_image = 16 + local5
                            }
                            of flags & 4096 > 0 {
                                cursor_image = 19 + local5
                            }
                            of flags & 8192 > 0 {
                                cursor_image = 22 + local5
                            }
                            of flags & 16384 > 0 {
                                cursor_image = 25 + local5
                            }
                            of flags & 32768 > 0 {
                                cursor_image = 28 + local5
                            }
                            of flags & 32 > 0 {
                                cursor_image = 4
                            }
                            else {
                                cursor_image = 4
                                if (flags & 134217728) {
                                    cursor_image = 1
                                }
                            }
                        }
                    }
                    if (cursor_image != gCursorImage) {
                        if (g_maybe_operating_system == 2) {
                            cursor-set-image-color (cursor_image + 2)
                            gCursorImage = cursor_image + 2
                        } else if (cursor_image <= 76 || (cursor_image in [82, 85, 91, 88, 79, 95])) {
                            cursor-set-image-bw (cursor_image + 1)
                            gCursorImage = cursor_image + 1
                        } else if (gBlackAndWhiteCursors || cursor_image == 1) {
                            cursor-set-image-bw (cursor_image + 1)
                            gCursorImage = cursor_image + 1
                        } else {
                            cursor-set-image-color cursor_image
                            gCursorImage = cursor_image
                        }
                    }
                } else if (id == 0) {
                    if (1 != gCursorImage) {
                        if (g_maybe_operating_system == 2) {
                            cursor-set-image-color (1 + 2)
                            gCursorImage = 1 + 2
                        } else if (1 <= 76 || (1 in [82, 85, 91, 88, 79, 95])) {
                            cursor-set-image-bw (1 + 1)
                            gCursorImage = 1 + 1
                        } else if (gBlackAndWhiteCursors || 1 == 1) {
                            cursor-set-image-bw (1 + 1)
                            gCursorImage = 1 + 1
                        } else {
                            cursor-set-image-color 1
                            gCursorImage = 1
                        }
                        run-script maybe_HideNavHoverText []
                    }
                }
                gLastHoverNumber = id
                gLastHoverType = type
                last_flags = flags
            } else {
                if (local8 > 0) {
                    --local8
                }
                if (local8 == 0) {
                    case type {
                        of 2 {
                            local9 = gSpriteCursorTargets[id][TARGET-HOVER-SCRIPT]
                        }
                        of 1 {
                            local9 = gActorCursorTargets[id][TARGET-HOVER-SCRIPT]
                        }
                        of 3 {
                            local9 = 0
                        }
                        else {
                            local9 = 0
                        }
                    }
                    if (local9) {
                        local8 = -1
                        run-script-xc3 local9 [id]
                    }
                }
            }
        } else if (gCursorImage != 1) {
            if (g_maybe_operating_system == 2) {
                cursor-set-image-color (1 + 2)
                gCursorImage = 1 + 2
            } else if (1 <= 76 || (1 in [82, 85, 91, 88, 79, 95])) {
                cursor-set-image-bw (1 + 1)
                gCursorImage = 1 + 1
            } else if (gBlackAndWhiteCursors || 1 == 1) {
                cursor-set-image-bw (1 + 1)
                gCursorImage = 1 + 1
            } else {
                cursor-set-image-color 1
                gCursorImage = 1
            }
            run-script maybe_HideNavHoverText []
        }
    } else {
        last_flags = -1
    }
    temp = random 1
    stop-script
}
free-script
